npi:
  relationships:
    - npis:
      - many:
          name: provider_details
          table: npi_provider_details
      - many: 
          name: other_identifiers
          table: npi_other_identifiers
      - one: 
          name: business_address
          table: npi_addresses
      - one:
          name: practice_address
          table: npi_addresses
      - one:
          name: organization_official
          table: npi_organization_officials
      - one:
          name: parent_org
          table: parent_orgs
    - npi_other_identifiers:
      - one: hptc
  api:
    - npis
  create:
    - fetch_npi_path: set=npi_path
    - download: url=http://nppes.viva-it.com/{{npi_path}}
    - unzip: path={{npi_path}}
    - fix_npi: file=/npidata_(\d+)_(\d+)\.csv/
    - csv_create: tables={{tables}}
  update:
    - fetch_npi_weekly_paths: set=npi_paths
    - each:
        on: {{npi_paths}}
        set: npi_path
        do:
          - clear_files
          - download: url=http://nppes.viva-it.com/{{npi_path}}
          - unzip: path={{npi_path}}
          - fix_npi: file=/npidata_(\d+)_(\d+)\.csv/
          - csv_import: tables={{tables}}
  variables:
    tables:
      npi_provider_details:
        id:
          composite:
            - npi
            - {1}
          primary_key: true
        npi:
          named: npi
          type: bigint
        healthcare_taxonomy_code:
          named: /healthcare_provider_taxonomy_code_(.+)/
          type: string/70
        license_number:
          named: /provider_license_number_(.+)/
          type: string/20
        license_number_state:
          named: /provider_license_number_state_code_(.+)/
          type: string/9
          map:
            S: state
            T: territory
        taxonomy_switch:
          named: /healthcare_provider_primary_taxonomy_switch_(.+)/
          type: string/12
          map:
            X: not answered
            Y: yes
            N: no
      npi_other_identifiers:
        id:
          composite:
            - npi
            - {1}
          primary_key: true
        npi:
          named: npi
          type: bigint
        identifier:
          named: /other_provider_identifier_(.+)/
          type: string/20
        type:
          named: /other_provider_identifier_type_code_(.+)/
          type: string/30
          map:
            "01": other
            "02": medicare upin
            "04": medicare id-type unspecified
            "05": medicaid
            "06": medicare oscar/certification
            "07": medicare nsc
            "08": medicare pin
        state: 
          named: /other_provider_identifier_state_(.+)/
          type: string/2
        issuer:
          named: /other_provider_identifier_issuer_(.+)/
          type: string/80
      npi_addresses:
        id:
          composite:
            - /provider_first_line_business_(.+)_address/
            - /provider_second_line_business_(.+)_address/
            - /provider_business_(.+)_address_city_name/
            - /provider_business_(.+)_address_state_name/
            - /provider_business_(.+)_address_postal_code/
            - /provider_business_(.+)_address_country_code_if_outside_u_s/
            - /provider_business_(.+)_address_telephone_number/
            - /provider_business_(.+)_address_fax_number/
          primary_key: true
        address_line: 
          named: /provider_first_line_business_(.+)_address/
          type: string/55
        address_details_line:
          named: /provider_second_line_business_(.+)_address/
          type: string/55
        city:
          named: /provider_business_(.+)_address_city_name/
          type: string/40
        state:
          named: /provider_business_(.+)_address_state_name/
          type: string/40
        zip:
          named: /provider_business_(.+)_address_postal_code/
          type: string/20
        country_code:
          named: /provider_business_(.+)_address_country_code_if_outside_u_s/
          type: string/2
        phone:
          named: /provider_business_(.+)_address_telephone_number
          type: string/20
        fax:
          named: /provider_business_(.+)_address_fax_number/
          type: string/20
      npi_organization_officials:
        id:
          composite:
            - authorized_official_last_name
            - authorized_official_first_name
            - authorized_official_middle_name
            - authorized_official_title_or_position
            - authorized_official_telephone_number
            - authorized_official_name_prefix_text
            - authorized_official_name_suffix_text
            - authorized_official_credential_text
          primary_key: true
        first_name:
          named: authorized_official_first_name
          type: string/20
        last_name:
          named: authorized_official_last_name
          type: string/20
        middle_name:
          named: authorized_official_middle_name
          type: string/20
        title:
          named: authorized_official_title_or_position
          type: string/35
        phone:
          named: authorized_official_telephone_number
          type: string/20
        name_prefix:
          named: authorized_official_name_prefix_text
          type: string/5
        name_suffix:
          named: authorized_official_name_suffix_text
          type: string/5
        credential: authorized_official_credential_text
      npi_parent_orgs:
        id:
          composite:
            - parent_organization_lbn
            - parent_organization_tin
          primary_key: true
        tax_identification_number:
          named: parent_organization_tin
          type: string/9
        business_name:
          named: parent_organization_lbn
          type: string/70
      npis:
        npi:
          named: npi
          type: bigint
          primary_key: true
        type:
          named: entity_type_code
          type: string/12
          map:
            1: individual
            2: organization
        replacement_npi:
          named: replacement_npi
          type: bigint
        employer_identification_number:
          named: employer_identification_number_ein
          type: string/9
        business_name:
          named: provider_organization
          type: string/70
        last_name:
          named: provider_last_name_legal_name
          type: string/35
        first_name:
          named: provider_first_name
          type: string/20
        name_prefix:
          named: provider_name_prefix_text
          type: string/5
        middle_name:
          named: provider_middle_name
          type: string/20
        name_suffix:
          named: provider_name_suffix_text
          type: string/5
        credential:
          named: provider_credential_text
          type: string/20
        other_name:
          named: provider_other_organization_name
          type: string/70
        other_org_type: 
          named: provider_other_organization_name_type_code
          type: string/24
          map:
            1: individual
            2: individual
            3: organization
            4: organization
            5: individual+organization
        other_last_name:
          named: provider_other_last_name
          type: string/35
        other_first_name:
          named: provider_other_first_name
          type: string/20
        other_middle_name:
          named: provider_other_middle_name
          type: string/20
        other_prefix:
          named: provider_other_name_prefix_text
          type: string/5
        other_suffix:
          named: provider_other_name_suffix_text
          type: string/5
        other_credential:
          named: provider_other_credential_text
          type: string/20
        other_name_type:
          named: provider_other_last_name_type_code
          type: string/27
          map:
            1: former name
            2: professional name
            3: doing business as
            4: former legal business name
            5: other name
        business_address_id:
          composite:
            - provider_first_line_business_mailing_address
            - provider_second_line_business_mailing_address
            - provider_business_mailing_address_city_name
            - provider_business_mailing_address_state_name
            - provider_business_mailing_address_postal_code
            - provider_business_mailing_address_country_code_if_outside_u_s
            - provider_business_mailing_address_telephone_number
            - provider_business_mailing_address_fax_number
        practice_address_id:
          composite:
            - provider_first_line_business_practice_address
            - provider_second_line_business_practicepractice_mailing_address
            - provider_business_practice_address_city_name
            - provider_business_practice_address_state_name
            - provider_business_practice_address_postal_code
            - provider_business_practice_address_country_code_if_outside_u_s
            - provider_business_practice_address_telephone_number
            - provider_business_practice_address_fax_number
        enumeration_date:
          named: provider_enumeration_date
          type: date
        deactivation_reason:
          named: npi_deactivation_reason
          type: string/12
          map:
            DT: death
            DB: disbandment
            FR: fraud
            OT: other
        deactivation_date:
          named: npi_deactivation_date
          type: date
        reactivation_date:
          named: npi_reactivation_date
          type: date
        gender:
          named: provider_gender_code
          type: string/6
          map:
            M: male
            F: female
        organization_official_id:
          composite:
            - authorized_official_last_name
            - authorized_official_first_name
            - authorized_official_middle_name
            - authorized_official_title_or_position
            - authorized_official_telephone_number
            - authorized_official_name_prefix_text
            - authorized_official_name_suffix_text
            - authorized_official_credential_text
        sole_proprietor:
          named: is_sole_proprietor
          type: string/13
          map:
            X: not answered
            Y: yes
            N: no
        organization_subpart:
          named: organization_subpart
          type: string/13
          map:
            X: not answered
            Y: yes
            N: no
        parent_org_id:
          composite:
            - parent_organization_lbn
            - parent_organization_tin
